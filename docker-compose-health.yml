version: '3.8'

networks:
  fis-network:
    driver: bridge

services:
  auth:
    build: ./auth
    container_name: fis-auth
    ports:
      - "8080:8080"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  catalogo:
    build: ./catalogo
    container_name: fis-catalogo
    ports:
      - "8081:8081"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  contenido:
    build: ./contenido
    container_name: fis-contenido
    ports:
      - "8082:8082"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  email:
    build: ./email
    container_name: fis-email
    ports:
      - "8083:8083"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  filtrocontenido:
    build: ./filtrocontenido
    container_name: fis-filtrocontenido
    ports:
      - "8084:8084"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  foro:
    build: ./foro
    container_name: fis-foro
    ports:
      - "8085:8085"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  geo:
    build: ./geo
    container_name: fis-geo
    ports:
      - "8086:8086"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mensajeria:
    build: ./mensajeria
    container_name: fis-mensajeria
    ports:
      - "8087:8087"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  moderacion:
    build: ./moderacion
    container_name: fis-moderacion
    ports:
      - "8088:8088"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  multimedia:
    build: ./multimedia
    container_name: fis-multimedia
    ports:
      - "8089:8089"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  noticia:
    build: ./noticia
    container_name: fis-noticia
    ports:
      - "8090:8090"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  pago:
    build: ./pago
    container_name: fis-pago
    ports:
      - "8091:8091"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  proveedor:
    build: ./proveedor
    container_name: fis-proveedor
    ports:
      - "8092:8092"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  usuario:
    build: ./usuario
    container_name: fis-usuario
    ports:
      - "8093:8093"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8093/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  vehiculo:
    build: ./vehiculo
    container_name: fis-vehiculo
    ports:
      - "8094:8094"
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:alpine
    container_name: fis-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      auth:
        condition: service_healthy
      catalogo:
        condition: service_healthy
      contenido:
        condition: service_healthy
      email:
        condition: service_healthy
      filtrocontenido:
        condition: service_healthy
      foro:
        condition: service_healthy
      geo:
        condition: service_healthy
      mensajeria:
        condition: service_healthy
      moderacion:
        condition: service_healthy
      multimedia:
        condition: service_healthy
      noticia:
        condition: service_healthy
      pago:
        condition: service_healthy
      proveedor:
        condition: service_healthy
      usuario:
        condition: service_healthy
      vehiculo:
        condition: service_healthy
    networks:
      - fis-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
