name: Validate Microservice PR
on:
  pull_request:
    branches:
      - master
      - desarrollo
    paths:
      - 'auth/**'
      - 'catalogo/**'
      - 'contenido/**'
      - 'email/**'
      - 'filtrocontenido/**'
      - 'foro/**'
      - 'geo/**'
      - 'mensajeria/**'
      - 'moderacion/**'
      - 'multimedia/**'
      - 'noticia/**'
      - 'pago/**'
      - 'proveedor/**'
      - 'usuario/**'
      - 'vehiculo/**'
      - 'docker-compose.yml'
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          
      - name: Determine updated microservice
        id: detect
        run: |
          echo "Detecting changed microservice folder..."
          BASE_REF="${{ github.base_ref }}"
          echo "Base branch: $BASE_REF"
          
          SRV=$(git diff --name-only origin/$BASE_REF...HEAD \
            | cut -d'/' -f1 \
            | sort -u \
            | grep -vE '^\.|^README|^docker-compose')
          
          echo "service=$SRV" >> $GITHUB_OUTPUT
          echo "Detected service: $SRV"
          
      - name: Fail if multiple services changed
        run: |
          COUNT=$(echo "${{ steps.detect.outputs.service }}" | wc -w)
          if [ "$COUNT" -ne 1 ]; then
            echo "âŒ ERROR: PR must modify only ONE microservice folder. Changed: $COUNT"
            exit 1
          fi
          
      - name: Extract server port
        id: port
        run: |
          SRV="${{ steps.detect.outputs.service }}"
          echo "Extracting port from microservice: $SRV"
          
          # Detectar archivo de configuraciÃ³n
          PROP_FILE=""
          if [ -f "$SRV/src/main/resources/application.properties" ]; then
            PROP_FILE="$SRV/src/main/resources/application.properties"
          elif [ -f "$SRV/src/main/resources/application.yml" ]; then
            PROP_FILE="$SRV/src/main/resources/application.yml"
          else
            echo "âŒ ERROR: No application.properties or application.yml found in $SRV"
            exit 1
          fi
          
          # Extract server.port
          PORT=$(grep -E "^server.port=" "$PROP_FILE" | cut -d'=' -f2 | tr -d '[:space:]')
          if [ -z "$PORT" ]; then
            echo "âŒ ERROR: server.port not defined in $PROP_FILE"
            exit 1
          fi
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "âœ” server.port detected: $PORT"
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          
      - name: Build and start microservice
        run: |
          SRV="${{ steps.detect.outputs.service }}"
          PORT="${{ steps.port.outputs.port }}"
          
          echo "ðŸ”¨ Building $SRV..."
          cd $SRV
          
          # Build with Maven or Gradle
          if [ -f "pom.xml" ]; then
            echo "Using Maven..."
            mvn clean package -DskipTests
            JAR_FILE=$(find target -name "*.jar" | grep -v "original" | head -n 1)
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "Using Gradle..."
            gradle clean build -x test
            JAR_FILE=$(find build/libs -name "*.jar" | grep -v "plain" | head -n 1)
          else
            echo "âŒ ERROR: No pom.xml or build.gradle found"
            exit 1
          fi
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ ERROR: No JAR file was generated"
            exit 1
          fi
          
          echo "ðŸ“¦ JAR file: $JAR_FILE"
          
          echo "ðŸš€ Starting $SRV on port $PORT..."
          SERVER_PORT=$PORT java -jar $JAR_FILE &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          echo "Process PID: $APP_PID"
          
          # Wait for app to start
          echo "â³ Waiting for service to be ready..."
          for i in {1..30}; do
            if curl -sf http://localhost:$PORT/actuator/health > /dev/null 2>&1; then
              echo "âœ… Service is UP!"
              exit 0
            fi
            echo "Attempt $i/30: waiting..."
            sleep 2
          done
          
          echo "âŒ ERROR: Service failed to start within 60 seconds"
          kill $APP_PID 2>/dev/null || true
          exit 1
          
      - name: Test actuator health endpoint
        run: |
          PORT="${{ steps.port.outputs.port }}"
          SRV="${{ steps.detect.outputs.service }}"
          
          echo "ðŸ©º Testing actuator health endpoint: http://localhost:$PORT/actuator/health"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:$PORT/actuator/health)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ERROR: Actuator health endpoint returned HTTP $HTTP_CODE (expected 200)"
            exit 1
          fi
          
          if echo "$BODY" | grep -q '"status":"UP"'; then
            echo "âœ… Health endpoint is working correctly!"
          else
            echo "âŒ ERROR: Health endpoint did not return status UP"
            echo "Response: $BODY"
            exit 1
          fi
          
      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            echo "ðŸ§¹ Stopping microservice (PID: $APP_PID)..."
            kill $APP_PID 2>/dev/null || true
          fi
          
      - name: Final result
        run: echo "ðŸŽ‰ Validation completed successfully!"