name: Validate Microservice PR
on:
  pull_request:
    branches:
      - master
      - desarrollo
    paths:
      - 'auth/**'
      - 'catalogo/**'
      - 'contenido/**'
      - 'email/**'
      - 'filtrocontenido/**'
      - 'foro/**'
      - 'geo/**'
      - 'mensajeria/**'
      - 'moderacion/**'
      - 'multimedia/**'
      - 'noticia/**'
      - 'pago/**'
      - 'proveedor/**'
      - 'usuario/**'
      - 'vehiculo/**'
      - 'docker-compose.yml'
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          
      - name: Determine updated microservice
        id: detect
        run: |
          echo "Detecting changed microservice folder..."
          BASE_REF="${{ github.base_ref }}"
          echo "Base branch: $BASE_REF"
          
          SRV=$(git diff --name-only origin/$BASE_REF...HEAD \
            | cut -d'/' -f1 \
            | sort -u \
            | grep -vE '^\.|^README|^docker-compose')
          
          echo "service=$SRV" >> $GITHUB_OUTPUT
          echo "Detected service: $SRV"
          
      - name: Fail if multiple services changed
        run: |
          COUNT=$(echo "${{ steps.detect.outputs.service }}" | wc -w)
          if [ "$COUNT" -ne 1 ]; then
            echo "‚ùå ERROR: PR must modify only ONE microservice folder. Changed: $COUNT"
            exit 1
          fi
          
      - name: Validate microservice port + actuator + compose healthcheck
        run: |
          SRV="${{ steps.detect.outputs.service }}"
          echo "Validating microservice: $SRV"
          
          # Detectar archivo de configuraci√≥n
          PROP_FILE=""
          if [ -f "$SRV/src/main/resources/application.properties" ]; then
            PROP_FILE="$SRV/src/main/resources/application.properties"
          elif [ -f "$SRV/src/main/resources/application.yml" ]; then
            PROP_FILE="$SRV/src/main/resources/application.yml"
          else
            echo "‚ùå ERROR: No application.properties or application.yml found in $SRV"
            exit 1
          fi
          
          # Extract server.port
          PORT=$(grep -E "^server.port=" "$PROP_FILE" | cut -d'=' -f2)
          if [ -z "$PORT" ]; then
            echo "‚ùå ERROR: server.port not defined in $PROP_FILE"
            exit 1
          fi
          echo "‚úî server.port detected: $PORT"
          
          # Check actuator enabled
          if grep -qi "management.endpoints.web.exposure.include" "$PROP_FILE"; then
            echo "‚úî Actuator exposure found"
          else
            echo "‚ùå ERROR: Actuator exposure NOT configured in $PROP_FILE"
            exit 1
          fi
          
          # Validate docker-compose service exists
          if ! grep -q "${SRV}:" docker-compose.yml; then
            echo "‚ùå ERROR: $SRV not defined in docker-compose.yml"
            exit 1
          fi
          
          # Validate SERVER_PORT matches
          if ! grep -q "SERVER_PORT: $PORT" docker-compose.yml; then
            echo "‚ùå ERROR: SERVER_PORT mismatch in docker-compose.yml. Expected: $PORT"
            exit 1
          fi
          echo "‚úî SERVER_PORT matches docker-compose.yml"
          
          # Validate healthcheck block reference
          if ! grep -A5 "${SRV}:" docker-compose.yml | grep -q "healthcheck"; then
            echo "‚ùå ERROR: $SRV does NOT inherit or declare healthcheck using x-healthcheck"
            exit 1
          fi
          echo "‚úî Healthcheck found in docker-compose for $SRV"
          
      - name: Final result
        run: echo "üéâ Validation completed successfully!"