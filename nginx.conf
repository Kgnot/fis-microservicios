events {
    worker_connections 1024;
}

http {
    # Resolver DNS de Docker para que Nginx pueda encontrar los contenedores
    resolver 127.0.0.11 valid=30s;
    
    # Definición de Upstreams usando los container_name definidos en docker-compose.yml
    upstream auth {
        server fis-auth:8080;
    }
    
    upstream catalogo {
        server fis-catalogo:8081;
    }
    
    upstream contenido {
        server fis-contenido:8082;
    }
    
    upstream email {
        server fis-email:8083;
    }
    
    upstream filtrocontenido {
        server fis-filtrocontenido:8084;
    }
    
    upstream foro {
        server fis-foro:8085;
    }
    
    upstream geo {
        server fis-geo:8086;
    }
    
    upstream mensajeria {
        server fis-mensajeria:8087;
    }
    
    upstream moderacion {
        server fis-moderacion:8088;
    }
    
    upstream multimedia {
        server fis-multimedia:8089;
    }
    
    upstream noticia {
        server fis-noticia:8090;
    }
    
    upstream pago {
        server fis-pago:8091;
    }
    
    upstream proveedor {
        server fis-proveedor:8092;
    }
    
    upstream usuario {
        server fis-usuario:8093;
    }
    
    upstream vehiculo {
        server fis-vehiculo:8094;
    }

    server {
        listen 80;
        server_name localhost;

        # Health check endpoint para Nginx
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Rutas para cada microservicio
        # Se usa proxy_pass http://<nombre_upstream>/
        
        location /api/auth/ {
            proxy_pass http://auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/catalogo/ {
            proxy_pass http://catalogo/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/contenido/ {
            proxy_pass http://contenido/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/email/ {
            proxy_pass http://email/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/filtrocontenido/ {
            proxy_pass http://filtrocontenido/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/foro/ {
            proxy_pass http://foro/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/geo/ {
            proxy_pass http://geo/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/mensajeria/ {
            proxy_pass http://mensajeria/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/moderacion/ {
            proxy_pass http://moderacion/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/multimedia/ {
            proxy_pass http://multimedia/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/noticia/ {
            proxy_pass http://noticia/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/pago/ {
            proxy_pass http://pago/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/proveedor/ {
            proxy_pass http://proveedor/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/usuario/ {
            proxy_pass http://usuario/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location /api/vehiculo/ {
            proxy_pass http://vehiculo/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Página de bienvenida
        location / {
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>FIS Microservices Gateway</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        .service { background: #f4f4f4; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .service a { color: #0066cc; text-decoration: none; }
        .service a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>FIS Microservices Gateway</h1>
    <p>Bienvenido al gateway de microservicios. Servicios disponibles:</p>
    
    <div class="service"><strong>Auth:</strong> <a href="/api/auth/actuator/health">/api/auth/</a></div>
    <div class="service"><strong>Catalogo:</strong> <a href="/api/catalogo/actuator/health">/api/catalogo/</a></div>
    <div class="service"><strong>Contenido:</strong> <a href="/api/contenido/actuator/health">/api/contenido/</a></div>
    <div class="service"><strong>Email:</strong> <a href="/api/email/actuator/health">/api/email/</a></div>
    <div class="service"><strong>Filtro Contenido:</strong> <a href="/api/filtrocontenido/actuator/health">/api/filtrocontenido/</a></div>
    <div class="service"><strong>Foro:</strong> <a href="/api/foro/actuator/health">/api/foro/</a></div>
    <div class="service"><strong>Geo:</strong> <a href="/api/geo/actuator/health">/api/geo/</a></div>
    <div class="service"><strong>Mensajeria:</strong> <a href="/api/mensajeria/actuator/health">/api/mensajeria/</a></div>
    <div class="service"><strong>Moderacion:</strong> <a href="/api/moderacion/actuator/health">/api/moderacion/</a></div>
    <div class="service"><strong>Multimedia:</strong> <a href="/api/multimedia/actuator/health">/api/multimedia/</a></div>
    <div class="service"><strong>Noticia:</strong> <a href="/api/noticia/actuator/health">/api/noticia/</a></div>
    <div class="service"><strong>Pago:</strong> <a href="/api/pago/actuator/health">/api/pago/</a></div>
    <div class="service"><strong>Proveedor:</strong> <a href="/api/proveedor/actuator/health">/api/proveedor/</a></div>
    <div class="service"><strong>Usuario:</strong> <a href="/api/usuario/actuator/health">/api/usuario/</a></div>
    <div class="service"><strong>Vehiculo:</strong> <a href="/api/vehiculo/actuator/health">/api/vehiculo/</a></div>
</body>
</html>';
            add_header Content-Type text/html;
        }
    }
}
